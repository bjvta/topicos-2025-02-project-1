# Proyecto de Ejemplo: Testing de Sistema de Inscripci√≥n

Este proyecto es un ejemplo completo de c√≥mo implementar **unit tests** e **integration tests** para un sistema de inscripci√≥n universitaria.

## üìÅ Estructura del Proyecto

```
clase-07-testing/
‚îú‚îÄ‚îÄ src/                          # C√≥digo fuente
‚îÇ   ‚îú‚îÄ‚îÄ validators/               # Validadores de l√≥gica de negocio
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ seatsValidator.js     # Validaci√≥n de cupos disponibles
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ scheduleValidator.js  # Validaci√≥n de choques de horario
‚îÇ   ‚îú‚îÄ‚îÄ services/                 # Servicios de negocio
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ enrollmentService.js  # L√≥gica de inscripci√≥n
‚îÇ   ‚îî‚îÄ‚îÄ config/                   # Configuraci√≥n (futuro)
‚îÇ
‚îú‚îÄ‚îÄ tests/                        # Tests
‚îÇ   ‚îú‚îÄ‚îÄ unit/                     # Unit tests (l√≥gica aislada)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ validators/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ seatsValidator.test.js       # Tests de validaci√≥n de cupos
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ scheduleValidator.test.js    # Tests de validaci√≥n de horarios
‚îÇ   ‚îú‚îÄ‚îÄ integration/              # Integration tests (flujo completo)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ enrollmentFlow.test.js           # Tests del flujo de inscripci√≥n
‚îÇ   ‚îî‚îÄ‚îÄ helpers/                  # Utilidades para tests
‚îÇ       ‚îî‚îÄ‚îÄ fixtures.js           # Datos de prueba (estudiantes, materias)
‚îÇ
‚îú‚îÄ‚îÄ package.json                  # Dependencias del proyecto
‚îú‚îÄ‚îÄ jest.config.js                # Configuraci√≥n de Jest
‚îî‚îÄ‚îÄ README.md                     # Este archivo
```

## üöÄ Instalaci√≥n

### 1. Instalar dependencias

```bash
npm install
```

Esto instalar√°:
- `jest`: Framework de testing
- `@jest/globals`: Funciones globales de Jest para ES modules
- `uuid`: Para generar IDs √∫nicos

### 2. Verificar instalaci√≥n

```bash
npm test
```

Deber√≠as ver todos los tests ejecut√°ndose correctamente.

## üìù Comandos Disponibles

### Comandos B√°sicos

| Comando | Descripci√≥n |
|---------|-------------|
| `npm test` | Ejecuta todos los tests |
| `npm run test:unit` | Ejecuta solo los unit tests |
| `npm run test:integration` | Ejecuta solo los integration tests |
| `npm run test:watch` | Ejecuta tests en modo watch (se re-ejecutan al cambiar c√≥digo) |
| `npm run test:coverage` | Genera reporte de cobertura de c√≥digo |

### Comandos Avanzados (Desarrollo)

**Ejecutar un archivo de test espec√≠fico:**

```bash
# Ejecutar solo seatsValidator.test.js
npm test tests/unit/validators/seatsValidator.test.js

# Ejecutar solo enrollmentFlow.test.js
npm test tests/integration/enrollmentFlow.test.js
```

**Ejecutar un test espec√≠fico por nombre:**

```bash
# Ejecutar solo el test que contiene "should return valid when seats are available"
npm test -- -t "should return valid when seats are available"

# Ejecutar todos los tests que contienen "concurrent"
npm test -- -t "concurrent"

# Ejecutar tests que coincidan con un patr√≥n
npm test -- -t "PENDING.*CONFIRMED"
```

**Ejecutar tests con m√°s informaci√≥n (verbose):**

```bash
npm test -- --verbose
```

**Ejecutar tests y detener en el primer error:**

```bash
npm test -- --bail
```

**Combinaciones √∫tiles:**

```bash
# Ejecutar un archivo espec√≠fico en modo watch
npm test -- --watch tests/unit/validators/seatsValidator.test.js

# Ejecutar un test espec√≠fico con verbose
npm test -- -t "concurrent" --verbose

# Ejecutar solo tests que fallaron en la √∫ltima ejecuci√≥n
npm test -- --onlyFailures
```

## üß™ Tipos de Tests Incluidos

### Unit Tests

Los **unit tests** prueban funciones individuales de forma aislada, sin dependencias externas.

**Archivos:**
- `tests/unit/validators/seatsValidator.test.js` - 25 tests
- `tests/unit/validators/scheduleValidator.test.js` - 15 tests

**Ejemplo de unit test:**

```javascript
test('should return valid when seats are available', () => {
  const result = validateSeats({
    capacity: 10,
    enrolledCount: 8,
    requestedCount: 2
  });

  expect(result.valid).toBe(true);
  expect(result.availableSeats).toBe(2);
});
```

**Caracter√≠sticas:**
- ‚úÖ R√°pidos (milisegundos)
- ‚úÖ No requieren base de datos
- ‚úÖ F√°ciles de debuggear
- ‚úÖ Prueban casos edge

### Integration Tests

Los **integration tests** prueban el flujo completo desde la creaci√≥n de una inscripci√≥n hasta su procesamiento.

**Archivo:**
- `tests/integration/enrollmentFlow.test.js` - 20+ tests

**Ejemplo de integration test:**

```javascript
test('should complete full enrollment flow when seats are available', async () => {
  // 1. Setup: Create course
  const course = await db.createCourse({
    id: 'test-course-1',
    name: 'Programming I',
    capacity: 10,
    enrolledCount: 0
  });

  // 2. Create enrollment request
  const enrollment = await enrollmentService.createEnrollmentRequest({
    studentId: 'student-1',
    courseId: course.id,
    requestId: 'req-001'
  });

  // 3. Verify PENDING status
  expect(enrollment.status).toBe('PENDING');

  // 4. Process the queue (simulate worker)
  await enrollmentService.processNextJob();

  // 5. Verify CONFIRMED status
  const processed = await db.getEnrollment(enrollment.id);
  expect(processed.status).toBe('CONFIRMED');
});
```

**Caracter√≠sticas:**
- ‚úÖ Prueban el sistema completo
- ‚úÖ Usan base de datos en memoria
- ‚úÖ Validan comportamiento as√≠ncrono
- ‚úÖ Detectan problemas de integraci√≥n

## üéØ Escenarios de Prueba Cubiertos

### Validaci√≥n de Cupos (Unit Tests)
- ‚úÖ Cupos disponibles
- ‚úÖ Sin cupos disponibles
- ‚úÖ Exactamente los cupos justos
- ‚úÖ Edge cases (capacidad 0, n√∫meros negativos)
- ‚úÖ Validaci√≥n de par√°metros inv√°lidos

### Validaci√≥n de Horarios (Unit Tests)
- ‚úÖ Detecci√≥n de choques de horario
- ‚úÖ Materias en diferentes d√≠as (sin choque)
- ‚úÖ Materias consecutivas (sin choque)
- ‚úÖ M√∫ltiples slots de tiempo
- ‚úÖ Validaci√≥n de inscripci√≥n masiva

### Flujo de Inscripci√≥n (Integration Tests)
- ‚úÖ Flujo completo: PENDING ‚Üí CONFIRMED
- ‚úÖ Flujo de rechazo: PENDING ‚Üí REJECTED
- ‚úÖ Manejo de concurrencia (m√∫ltiples solicitudes)
- ‚úÖ Idempotencia (requests duplicadas)
- ‚úÖ Manejo de errores
- ‚úÖ Edge cases (capacidad 0, cola vac√≠a)

## üìä Cobertura de C√≥digo

Para ver el reporte de cobertura:

```bash
npm run test:coverage
```

Esto generar√° un reporte en la carpeta `coverage/` que puedes abrir en el navegador:

```bash
open coverage/lcov-report/index.html   # En macOS
xdg-open coverage/lcov-report/index.html   # En Linux
start coverage/lcov-report/index.html  # En Windows
```

## üí° Conceptos Clave Demostrados

### 1. Pir√°mide de Testing

Este proyecto sigue la pir√°mide de testing:
- **Base (Unit Tests):** 40 tests - r√°pidos, aislados, muchos
- **Medio (Integration Tests):** 20 tests - moderados, realistas
- **Cima (E2E Tests):** No incluidos en este ejemplo

### 2. Arrange-Act-Assert (AAA)

Todos los tests siguen el patr√≥n AAA:

```javascript
test('description', () => {
  // Arrange: Setup inicial
  const input = { capacity: 10, enrolledCount: 5 };

  // Act: Ejecutar la funci√≥n
  const result = validateSeats(input);

  // Assert: Verificar el resultado
  expect(result.valid).toBe(true);
});
```

### 3. Testing As√≠ncrono

Los integration tests demuestran c√≥mo testear c√≥digo as√≠ncrono:

```javascript
test('async operation', async () => {
  const result = await enrollmentService.createEnrollmentRequest({
    studentId: 'student-1',
    courseId: 'course-1',
    requestId: 'req-001'
  });

  expect(result.status).toBe('PENDING');
});
```

### 4. Idempotencia

El sistema implementa idempotencia usando `requestId`:

```javascript
// Primera solicitud
const enrollment1 = await enrollmentService.createEnrollmentRequest({
  studentId: 'student-1',
  courseId: 'course-1',
  requestId: 'duplicate-req-001'
});

// Segunda solicitud con mismo requestId
const enrollment2 = await enrollmentService.createEnrollmentRequest({
  studentId: 'student-1',
  courseId: 'course-1',
  requestId: 'duplicate-req-001'
});

// Ambas devuelven la misma inscripci√≥n
expect(enrollment1.id).toBe(enrollment2.id);
```

## üîç Explorando el C√≥digo

### 1. Validadores (`src/validators/`)

Contienen la l√≥gica pura de validaci√≥n:
- **`seatsValidator.js`**: Valida si hay cupos disponibles
- **`scheduleValidator.js`**: Valida choques de horario

### 2. Servicios (`src/services/`)

Contienen la l√≥gica de negocio:
- **`enrollmentService.js`**: Maneja el flujo de inscripci√≥n completo
  - Base de datos en memoria (InMemoryDatabase)
  - Creaci√≥n de solicitudes
  - Procesamiento de cola
  - Idempotencia

### 3. Tests (`tests/`)

Organizados por tipo:
- **`unit/`**: Tests de funciones individuales
- **`integration/`**: Tests de flujos completos
- **`helpers/`**: Datos de prueba (fixtures)

## üéì Ejercicios Sugeridos

### Ejercicio 1: Agregar validaci√≥n de prerequisitos

1. Crear funci√≥n `validatePrerequisites(studentId, courseId)` en `src/validators/`
2. Escribir unit tests en `tests/unit/validators/`
3. Integrar en `enrollmentService.js`
4. Agregar integration test

### Ejercicio 2: Implementar waitlist

1. Modificar `enrollmentService.js` para crear inscripciones en estado `WAITLISTED`
2. Agregar l√≥gica para promover de waitlist cuando hay cupos
3. Escribir tests para el nuevo flujo

### Ejercicio 3: Agregar m√°s validaciones

Algunas ideas:
- Validar l√≠mite de cr√©ditos por semestre
- Validar que estudiante no est√© suspendido
- Validar fecha l√≠mite de inscripci√≥n
- Validar choques con horarios personales del estudiante

## üìö Recursos Adicionales

### Documentaci√≥n

- [Jest Documentation](https://jestjs.io/docs/getting-started)
- [Testing Best Practices](https://testingjavascript.com/)
- [Martin Fowler - Testing](https://martinfowler.com/testing/)

### Lecturas Recomendadas

- *Test Driven Development: By Example* - Kent Beck
- *Growing Object-Oriented Software, Guided by Tests* - Steve Freeman & Nat Pryce
- *The Art of Unit Testing* - Roy Osherove

## ‚ùì Preguntas Frecuentes

### ¬øPor qu√© usar Jest en lugar de Mocha/Chai?

Jest es m√°s moderno, tiene todo integrado (assertions, mocking, coverage) y es m√°s r√°pido gracias a su ejecuci√≥n en paralelo.

### ¬øPor qu√© no usar una base de datos real?

Para tests, una base de datos en memoria es:
- ‚úÖ M√°s r√°pida
- ‚úÖ M√°s f√°cil de configurar
- ‚úÖ No requiere infraestructura externa
- ‚úÖ F√°cil de limpiar entre tests

Para tests E2E o staging, s√≠ usar√≠as una base de datos real.

### ¬øCu√°nto coverage debo tener?

No hay un n√∫mero m√°gico, pero:
- **80%+** es un buen objetivo
- **90%+** es excelente
- **100%** es innecesario (diminishing returns)

Lo m√°s importante es testear **casos cr√≠ticos** y **edge cases**.

### ¬øC√≥mo debuggeo un test que falla?

**Opci√≥n 1: Ejecutar solo ese test**
```bash
# Por nombre del test
npm test -- -t "nombre del test"

# Por archivo espec√≠fico
npm test tests/unit/validators/seatsValidator.test.js
```

**Opci√≥n 2: Agregar console.log**
```javascript
test('mi test', () => {
  const result = validateSeats({ capacity: 10, enrolledCount: 5 });
  console.log('Debug result:', result); // ‚Üê Agregar aqu√≠
  expect(result.valid).toBe(true);
});
```

**Opci√≥n 3: Usar el debugger de Node.js**
```bash
node --inspect-brk node_modules/.bin/jest --runInBand
# Luego abrir chrome://inspect en Chrome
```

**Opci√≥n 4: Modo watch + solo un archivo**
```bash
npm test -- --watch tests/unit/validators/seatsValidator.test.js
# Modifica el c√≥digo y el test se re-ejecuta autom√°ticamente
```

### ¬øC√≥mo ejecuto solo un archivo de tests?

```bash
# M√©todo 1: Pasar la ruta del archivo
npm test tests/unit/validators/seatsValidator.test.js

# M√©todo 2: Usar patr√≥n
npm test -- --testPathPattern=seatsValidator

# M√©todo 3: En modo watch (muy √∫til durante desarrollo)
npm test -- --watch tests/unit/validators/seatsValidator.test.js
```

### ¬øC√≥mo ejecuto solo un test espec√≠fico dentro de un archivo?

```bash
# Usar -t (--testNamePattern) con el nombre exacto o parte del nombre
npm test -- -t "should return valid when seats are available"

# Usar regex para m√∫ltiples tests relacionados
npm test -- -t "concurrent"

# Combinar archivo + test espec√≠fico
npm test tests/integration/enrollmentFlow.test.js -t "concurrent"
```

**Tip:** Tambi√©n puedes usar `.only` temporalmente en el c√≥digo:

```javascript
// Ejecutar SOLO este test (ignorar los dem√°s)
test.only('should return valid when seats are available', () => {
  // ...
});

// O ejecutar SOLO los tests de este describe
describe.only('Concurrency handling', () => {
  test('test 1', () => { /* ... */ });
  test('test 2', () => { /* ... */ });
});
```

**‚ö†Ô∏è Importante:** Recuerda quitar `.only` antes de hacer commit!

## ü§ù Contribuciones

Este es un proyecto de ejemplo con fines educativos. Si encuentras errores o mejoras, ¬°si√©ntete libre de hacer un fork y experimentar!

## üìÑ Licencia

MIT - Libre para uso educativo y comercial.

---

**Creado para el curso de T√≥picos Avanzados - UAGRM 2025**

¬°Feliz testing! üß™‚ú®
